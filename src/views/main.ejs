<!-- banner -->
<%- include('banner.ejs') %>

<div class="main-wrap">
    <div class="container-md" id="mainContainer">
        <% if (user) { %>
        <div>
            <div class="mainHeader">
                <div id="recommendedHeader">
                    <h1>üíñ <%- user.nickname %> ÎãòÏùÑ ÏúÑÌïú Ï∂îÏ≤ú Í≥µÍ≥†</h1>
                </div>
                <a href="/jobposts?sort=recommended&order=desc">
                    <p>Ï∂îÏ≤ú Í≥µÍ≥† Ï†ÑÏ≤¥Î≥¥Í∏∞ ‚Üí</p>
                </a>
            </div>
            <div id="carouselRecommended" class="carousel carousel-dark slide">
                <div class="carousel-inner">
                    <div class="spinner-recommend">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div class="carousel-item active">
                        <div
                            class="row row-cols-1 row-cols-md-4 g-4"
                            id="carouselRecommended1"
                        ></div>
                    </div>
                    <div class="carousel-item">
                        <div
                            class="row row-cols-1 row-cols-md-4 g-4"
                            id="carouselRecommended2"
                        ></div>
                    </div>
                    <div class="carousel-item">
                        <div
                            class="row row-cols-1 row-cols-md-4 g-4"
                            id="carouselRecommended3"
                        ></div>
                    </div>
                </div>
                <button
                    class="carousel-control-prev"
                    type="button"
                    data-bs-target="#carouselRecommended"
                    data-bs-slide="prev"
                >
                    <span
                        class="carousel-control-prev-icon"
                        aria-hidden="true"
                    ></span>
                    <span class="visually-hidden">Ïù¥Ï†Ñ</span>
                </button>
                <button
                    class="carousel-control-next"
                    type="button"
                    data-bs-target="#carouselRecommended"
                    data-bs-slide="next"
                >
                    <span
                        class="carousel-control-next-icon"
                        aria-hidden="true"
                    ></span>
                    <span class="visually-hidden">Îã§Ïùå</span>
                </button>
            </div>
        </div>
        <% } %>

        <div class="mainHeader">
            <h1>üî• Í¥ÄÏã¨ Ï£ºÎ™©! Ïù∏Í∏∞ Í≥µÍ≥†</h1>
            <a href="/jobposts?sort=popular&order=desc">
                <p>Ïù∏Í∏∞Ïàú Í≥µÍ≥† Ï†ÑÏ≤¥Î≥¥Í∏∞ ‚Üí</p>
            </a>
        </div>
        <div id="carouselPopular" class="carousel carousel-dark slide">
            <div class="carousel-inner">
                <div class="spinner-popular">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div class="carousel-item active">
                    <div
                        class="row row-cols-1 row-cols-md-4 g-4"
                        id="carouselPopular1"
                    ></div>
                </div>
                <div class="carousel-item">
                    <div
                        class="row row-cols-1 row-cols-md-4 g-4"
                        id="carouselPopular2"
                    ></div>
                </div>
                <div class="carousel-item">
                    <div
                        class="row row-cols-1 row-cols-md-4 g-4"
                        id="carouselPopular3"
                    ></div>
                </div>
            </div>
            <button
                class="carousel-control-prev"
                type="button"
                data-bs-target="#carouselPopular"
                data-bs-slide="prev"
            >
                <span
                    class="carousel-control-prev-icon"
                    aria-hidden="true"
                ></span>
                <span class="visually-hidden">Ïù¥Ï†Ñ</span>
            </button>
            <button
                class="carousel-control-next"
                type="button"
                data-bs-target="#carouselPopular"
                data-bs-slide="next"
            >
                <span
                    class="carousel-control-next-icon"
                    aria-hidden="true"
                ></span>
                <span class="visually-hidden">Îã§Ïùå</span>
            </button>
        </div>

        <div class="mainHeader">
            <h1>‚ú® Îî∞ÎÅàÎî∞ÎÅàÌïú ÏµúÏã† Í≥µÍ≥†</h1>
            <a href="/jobposts?sort=recent&order=desc">
                <p>ÏµúÏã†Ïàú Í≥µÍ≥† Ï†ÑÏ≤¥Î≥¥Í∏∞ ‚Üí</p>
            </a>
        </div>
        <div id="carouselRecent" class="carousel carousel-dark slide">
            <div class="carousel-inner">
                <div class="spinner-recent">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div class="carousel-item active">
                    <div
                        class="row row-cols-1 row-cols-md-4 g-4"
                        id="carouselRecent1"
                    ></div>
                </div>
                <div class="carousel-item">
                    <div
                        class="row row-cols-1 row-cols-md-4 g-4"
                        id="carouselRecent2"
                    ></div>
                </div>
                <div class="carousel-item">
                    <div
                        class="row row-cols-1 row-cols-md-4 g-4"
                        id="carouselRecent3"
                    ></div>
                </div>
            </div>
            <button
                class="carousel-control-prev"
                type="button"
                data-bs-target="#carouselRecent"
                data-bs-slide="prev"
            >
                <span
                    class="carousel-control-prev-icon"
                    aria-hidden="true"
                ></span>
                <span class="visually-hidden">Ïù¥Ï†Ñ</span>
            </button>
            <button
                class="carousel-control-next"
                type="button"
                data-bs-target="#carouselRecent"
                data-bs-slide="next"
            >
                <span
                    class="carousel-control-next-icon"
                    aria-hidden="true"
                ></span>
                <span class="visually-hidden">Îã§Ïùå</span>
            </button>
        </div>

        <div class="mainHeader">
            <h1>‚è∞ Í≥ß ÎßàÍ∞êÌïòÎäî Í≥µÍ≥†</h1>
        </div>
        <div id="carouselEnding" class="carousel carousel-dark slide">
            <div class="carousel-inner">
                <div class="spinner-ending">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div class="carousel-item active">
                    <div
                        class="row row-cols-1 row-cols-md-4 g-4"
                        id="carouselEnding1"
                    ></div>
                </div>
                <div class="carousel-item">
                    <div
                        class="row row-cols-1 row-cols-md-4 g-4"
                        id="carouselEnding2"
                    ></div>
                </div>
                <div class="carousel-item">
                    <div
                        class="row row-cols-1 row-cols-md-4 g-4"
                        id="carouselEnding3"
                    ></div>
                </div>
            </div>
            <button
                class="carousel-control-prev"
                type="button"
                data-bs-target="#carouselEnding"
                data-bs-slide="prev"
            >
                <span
                    class="carousel-control-prev-icon"
                    aria-hidden="true"
                ></span>
                <span class="visually-hidden">Ïù¥Ï†Ñ</span>
            </button>
            <button
                class="carousel-control-next"
                type="button"
                data-bs-target="#carouselEnding"
                data-bs-slide="next"
            >
                <span
                    class="carousel-control-next-icon"
                    aria-hidden="true"
                ></span>
                <span class="visually-hidden">Îã§Ïùå</span>
            </button>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Î°úÍ∑∏Ïù∏ Ìïú ÌöåÏõêÏù¥ Ï∞ú Ìïú Ï±ÑÏö©Í≥µÍ≥† Î≤àÌò∏ Î¶¨Ïä§Ìä∏
        const likedJobpostIds = getUserLikeJobpost()

        const userId = '<%= user?.userId %>'
        if (userId) {
            $.ajax({
                type: 'GET',
                url: `/api/jobpost/filter/${userId}/?sort=recommended&order=desc&limit=12`,
                success: function (response) {
                    if (response.message) {
                        const tempHtml = `
                            <div class="main-recommendation-warning">
                                <span class="material-symbols-outlined" id="recommendationWarning">
                                    report
                                </span>                                
                                ${response.message}
                            <div>
                        `
                        $('#recommendedHeader').append(tempHtml)
                    }

                    // bootstrap tooltip
                    const tooltipTriggerList = document.querySelectorAll(
                        '[data-bs-toggle="tooltip"]'
                    )
                    const tooltipList = [...tooltipTriggerList].map(
                        (tooltipTriggerEl) =>
                            new bootstrap.Tooltip(tooltipTriggerEl)
                    )

                    showCarouselJobposts(
                        'carouselRecommended',
                        response.data,
                        likedJobpostIds
                    )
                    document.querySelector('.spinner-recommend').style.display =
                        'none'
                },
            })
        }

        $.ajax({
            type: 'GET',
            url: '/api/jobpost/filter?sort=recent&order=desc&limit=12',
            success: function (response) {
                showCarouselJobposts(
                    'carouselRecent',
                    response.data,
                    likedJobpostIds
                )
                document.querySelector('.spinner-recent').style.display = 'none'
            },
        })
        $.ajax({
            type: 'GET',
            url: '/api/jobpost/filter?sort=popular&order=desc&limit=12',
            success: function (response) {
                showCarouselJobposts(
                    'carouselPopular',
                    response.data,
                    likedJobpostIds
                )
                document.querySelector('.spinner-popular').style.display =
                    'none'
            },
        })
        $.ajax({
            type: 'GET',
            url: '/api/jobpost/filter?sort=ending&order=asc&limit=12',
            success: function (response) {
                showCarouselJobposts(
                    'carouselEnding',
                    response.data,
                    likedJobpostIds
                )
                document.querySelector('.spinner-ending').style.display = 'none'
            },
        })
    })
    function showCarouselJobposts(carouselId, response, likedJobpostIds) {
        for (let i = 0; i < 12; i++) {
            // Ï±ÑÏö©Í≥µÍ≥† Î≤àÌò∏
            const jobpostId = response[i].jobpost_id
            // Ï±ÑÏö©Í≥µÍ≥†Í∞Ä Ï¢ãÏïÑÏöîÍ∞Ä ÎàåÎ¶∞Í±¥ÏßÄ ÏïàÎàåÎ¶∞Í±¥ÏßÄ boolean
            const isLiked = likedJobpostIds.includes(jobpostId) ? true : false
            const tempHtml = createJobpostCard(response[i], isLiked)
            const carouselNum = Math.floor(i / 4) + 1
            $(`#${carouselId}${carouselNum}`).append(tempHtml)
        }
    }
</script>
